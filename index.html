<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padd</title>
    <style>
        html,
        body {
            margin: 0;
            height: 100%;
        }

        body {
            box-sizing: border-box;
            padding: 20px;
            overflow: hidden;
        }

        #container {
            width: 100%;
            height: 100%;
            display: block;
        }

        #content {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            padding: 20px;
            resize: none;

        }
    </style>
</head>

<body>
    <div id="container">
        <textarea id="content" placeholder="">

        </textarea>
    </div>

    <script>

        const padd = document.querySelector("#content");

        const info = `Ctrl + S -> Export notes \nCtrl + D -> Delete`;

        padd.setAttribute("placeholder", info);

        const key = "scratchPadd";
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const docref = urlParams.get('ref') ?? randomUniqueRef();
        let doc = localStorage.getItem(key + docref) || createDoc();

        if (!urlParams.get('ref')) {
            urlParams.set('ref', docref)
            let url = new URL(window.location.href);
            url.search = urlParams.toString();
            history.replaceState(null, null, url.toString());
            saveDoc(docref, key, JSON.stringify(doc));
        }

        padd.textContent = doc.content;

        padd.addEventListener('input', (event) => {
            doc.content = event.target.value;
            saveDoc(docref, key, JSON.stringify(doc));
        });

        document.addEventListener('keydown', function (event) {
            if (event.ctrlKey) {

                event.preventDefault();

                switch (event.key) {
                    case 's': exportToFile(docref, doc);
                        break;
                    case 'd': deleteDoc(docref);
                        window.location.href = window.location.origin;
                        break;
                }

            }
        });


        function createDoc() {
            return { content: '', created: Date.now(), edited: Date.now() };
        }

        function deleteDoc(ref) {
            localStorage.removeItem(`${key}_${ref}`);
            doc = { content: '', created: Date.now(), edited: Date.now() };
            padd.textContent = doc.content;
        }

        function exportToFile(ref, doc) {

            const blob = new Blob([doc.content], { type: "text/plain" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = `${ref}.txt`;
            document.body.appendChild(a);
            a.click();

            URL.revokeObjectURL(url);
            a.remove();
        }


        function getDoc(ref, key) {
            return localStorage.getItem(`${key}_${ref}`);
        }

        function saveDoc(ref, key, doc) {
            localStorage.setItem(`${key}_${ref}`, doc);
        }

        function randomUniqueRef(length = 8) {
            let result = '';
            do {
                result = '';
                while (result.length < length) {
                    result += Math.random().toString(36).slice(2);
                }
                result = result.slice(0, length);
            } while (getDoc(result, key) != null)

            return result;
        }

    </script>

</body>

</html>