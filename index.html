<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="fav.svg" type="image/svg+xml">
    <title>Scratchpad</title>
    <style>
        html,
        body {
            margin: 0;
            height: 100%;
        }

        body {
            box-sizing: border-box;
            padding: 20px;
            overflow: hidden;
        }

        #container {
            width: 100%;
            height: 100%;
            display: block;
        }

        #content {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            padding: 20px;
            resize: none;

        }
    </style>
</head>

<body>
    <div id="container">
        <textarea id="content" placeholder="">

        </textarea>
    </div>

    <script>

        const padd = document.querySelector("#content");

        const info = `Ctrl + S -> Export notes \nCtrl + D -> Delete\nCtrl + X -> Clear\nCtrl + R -> Run`;

        padd.setAttribute("placeholder", info);

        const key = "scratchPadd";
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const docref = urlParams.get('ref') ?? randomUniqueRef();
        let doc = localStorage.getItem(key + docref) || createDoc();

        if (!urlParams.get('ref')) {
            urlParams.set('ref', docref)
            let url = new URL(window.location.href);
            url.search = urlParams.toString();
            history.replaceState(null, null, url.toString());
            saveDoc(docref, key, JSON.stringify(doc));
        }

        padd.value = doc.content;

        padd.addEventListener('input', (event) => {
            doc.content = event.target.value;
            saveDoc(docref, key, JSON.stringify(doc));
        });

        document.addEventListener('keydown', function (event) {
            if (event.ctrlKey) {

                let handled = false;

                switch (event.key) {
                    case 's': exportToFile(docref, doc);
                        handled = true;
                        break;
                    case 'd': deleteDoc(docref);
                        window.location.href = window.location.origin;
                        handled = true;
                        break;
                    case 'x':
                        console.log("arghh")
                        doc.content = "";
                        padd.value = "";
                        saveDoc(docref, key, JSON.stringify(doc));
                        handled = true;
                        break;
                    case 'r': runCode(doc);
                        handled = true;
                        break;
                }

                if (handled) {
                    event.preventDefault();
                }

            }
        });


        function runCode(doc) {

            let result = '';
            try {
                let temp = console.log;
                let stack = []
                console.log = (...items) => { stack.push(...items); temp(...items) };
                eval(doc.content);
                console.log = temp;
                result = stack.join("\n");
            } catch (e) {
                result = e.toString();
            }

            padd.value += `\n${result}`;
        }


        function createDoc() {
            return { content: '', created: Date.now(), edited: Date.now() };
        }

        function deleteDoc(ref) {
            localStorage.removeItem(`${key}_${ref}`);
            doc = { content: '', created: Date.now(), edited: Date.now() };
            padd.value = doc.content;
        }

        function exportToFile(ref, doc) {

            const blob = new Blob([doc.content], { type: "text/plain" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = `${ref}.txt`;
            document.body.appendChild(a);
            a.click();

            URL.revokeObjectURL(url);
            a.remove();
        }


        function getDoc(ref, key) {
            return localStorage.getItem(`${key}_${ref}`);
        }

        function saveDoc(ref, key, doc) {
            doc.edited = Date.now();
            localStorage.setItem(`${key}_${ref}`, doc);
        }

        function randomUniqueRef(length = 8) {
            let result = '';
            do {
                result = '';
                while (result.length < length) {
                    result += Math.random().toString(36).slice(2);
                }
                result = result.slice(0, length);
            } while (getDoc(result, key) != null)

            return result;
        }

    </script>

</body>

</html>